services: 
  
  service-public:
    image: ghcr.io/bandwidth-gig-guide/service-public:latest
    container_name: service-public
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${SERVICE_PUBLIC_DB_USER}
      DB_PASSWORD: ${SERVICE_PUBLIC_DB_PASSWORD}
      DB_NAME: ${SERVICE_PUBLIC_DB_NAME}
    restart: unless-stopped
    networks:
      - bandwidth

  service-admin:
    image: ghcr.io/bandwidth-gig-guide/service-admin:latest
    container_name: service-admin
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${SERVICE_ADMIN_DB_USER}
      DB_PASSWORD: ${SERVICE_ADMIN_DB_PASSWORD}
      DB_NAME: ${SERVICE_ADMIN_DB_NAME}
      NEXT_PUBLIC_KEYCLOAK_URL: ${KEYCLOAK_URL}
      NEXT_PUBLIC_KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: ${SERVICE_ADMIN_KEYCLOAK_CLIENT_ID}
    restart: unless-stopped
    networks:
      - bandwidth

  service-search:
    image: ghcr.io/bandwidth-gig-guide/service-search:latest
    container_name: service-search
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${SERVICE_PUBLIC_DB_USER} # Publicly available, so can use public db account.
      DB_PASSWORD: ${SERVICE_PUBLIC_DB_PASSWORD}
      DB_NAME: ${SERVICE_PUBLIC_DB_NAME}
    restart: unless-stopped
    networks:
      - bandwidth

  service-auth:
    image: quay.io/keycloak/keycloak:latest
    container_name: service-auth
    command:
      - start
      - --http-enabled=true
      - --hostname=auth.bandwidth.melbourne
      - --hostname-strict=false
      - --proxy-headers=xforwarded
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://${SERVICE_AUTH_DB_HOST}:${SERVICE_AUTH_DB_PORT}/${SERVICE_AUTH_DB_NAME}
      KC_DB_USERNAME: ${SERVICE_AUTH_DB_USER}
      KC_DB_PASSWORD: ${SERVICE_AUTH_DB_PASSWORD}
      KC_BOOTSTRAP_ADMIN_USERNAME: ${SERVICE_AUTH_KEYCLOAK_ADMIN}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${SERVICE_AUTH_KEYCLOAK_ADMIN_PASSWORD}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    restart: unless-stopped
    volumes:
      - service-auth-data:/opt/keycloak/data
    networks:
      - bandwidth

  service-monitor:
    image: ghcr.io/dgtlmoon/changedetection.io:latest
    container_name: service-monitor
    volumes:
      - service-monitor-data:/datastore
      - /dev/shm:/dev/shm
    restart: unless-stopped
    networks:
      - bandwidth

  website-main:
    image: ghcr.io/bandwidth-gig-guide/website-main:latest
    container_name: website-main
    restart: unless-stopped
    networks:
      - bandwidth

  website-admin:
    image: ghcr.io/bandwidth-gig-guide/website-admin:latest
    container_name: website-admin
    restart: unless-stopped
    networks:
      - bandwidth

  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    user: "0:0"
    volumes:
    - /mnt/volume_syd1_01:/data
    - ./filebrowser.db:/database/filebrowser.db
    - ./filebrowser-settings.json:/config/settings.json
    restart: unless-stopped
    networks:
    - bandwidth

  reverse-proxy:
    image: caddy:2-alpine
    container_name: reverse-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./reverse-proxy-data:/data
      - ./reverse-proxy-config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile
    depends_on:
      - website-main
      - website-admin
      - service-public
      - service-auth
      - service-admin
      - service-search
      - service-monitor
      - filebrowser
    networks:
      - bandwidth

volumes:
  reverse-proxy-data:
    driver: local
    driver_opts:
      type: none
      device: /mnt/volume_syd1_01/docker/reverse-proxy-data
      o: bind

  reverse-proxy-config:
    driver: local
    driver_opts:
      type: none
      device: /mnt/volume_syd1_01/docker/reverse-proxy-config
      o: bind

  service-auth-data:
    driver: local
    driver_opts:
      type: none
      device: /mnt/volume_syd1_01/docker/service-auth-data
      o: bind

  service-monitor-data:
    driver: local
    driver_opts:
      type: none
      device: /mnt/volume_syd1_01/docker/service-monitor-data
      o: bind


networks:
  bandwidth:
    driver: bridge